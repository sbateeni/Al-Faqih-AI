{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <!-- Hero Section -->
    <div class="text-center mb-5">
        <h1 class="display-4 mb-3">المحادثة الفردية</h1>
        <p class="lead mb-4">تحدث مع العلماء واحصل على إجابات مفصلة لأسئلتك الشرعية</p>
    </div>

    <!-- Chat Interface -->
    <div class="row justify-content-center">
        <div class="col-lg-4 mb-4">
            <!-- Scholar Selection -->
            <div class="card shadow-lg mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tie me-2"></i>
                        اختر العالم
                    </h5>
                </div>
                <div class="card-body">
                    <select id="scholarSelect" class="form-select mb-3">
                        <option value="abu-hanifa">الإمام أبو حنيفة النعمان بن ثابت (80-150 هـ)</option>
                        <option value="malik">الإمام مالك بن أنس بن مالك الأصبحي (93-179 هـ)</option>
                        <option value="shafii">الإمام محمد بن إدريس الشافعي (150-204 هـ)</option>
                        <option value="ahmad">الإمام أحمد بن محمد بن حنبل الشيباني (164-241 هـ)</option>
                        <option value="bukhari">الإمام محمد بن إسماعيل البخاري (194-256 هـ)</option>
                        <option value="muslim">الإمام مسلم بن الحجاج النيسابوري (204-261 هـ)</option>
                        <option value="tirmidhi">الإمام محمد بن عيسى الترمذي (209-279 هـ)</option>
                        <option value="nasai">الإمام أحمد بن شعيب النسائي (215-303 هـ)</option>
                        <option value="ibn-majah">الإمام محمد بن يزيد بن ماجه القزويني (209-273 هـ)</option>
                        <option value="abu-dawood">الإمام سليمان بن الأشعث السجستاني (202-275 هـ)</option>
                        <option value="ghazali">الإمام أبو حامد محمد الغزالي (450-505 هـ)</option>
                        <option value="nawawi">الإمام يحيى بن شرف النووي (631-676 هـ)</option>
                        <option value="ibn-taymiyyah">الإمام أحمد بن عبد الحليم بن تيمية (661-728 هـ)</option>
                        <option value="ibn-kathir">الإمام إسماعيل بن عمر بن كثير (700-774 هـ)</option>
                    </select>
                    <div class="scholar-info mt-3">
                        <div class="text-center mb-3">
                            <i class="fas fa-user-circle fa-4x text-primary"></i>
                        </div>
                        <h6 class="text-center mb-2" id="scholarName">الإمام أبو حنيفة النعمان</h6>
                        <p class="text-muted text-center small" id="scholarInfo">
                            إمام المذهب الحنفي ومؤسس مدرسة الرأي في الفقه الإسلامي
                        </p>
                    </div>
                </div>
            </div>

            <!-- Chat History -->
            <div class="card shadow-lg">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        المحادثات السابقة
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="chatHistory" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        <!-- Chat history will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <!-- Chat Messages -->
            <div class="card shadow-lg">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        المحادثة
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="clearChat()">
                        <i class="fas fa-trash-alt me-1"></i>
                        مسح المحادثة
                    </button>
                </div>
                <div class="card-body">
                    <div id="chatMessages" class="chat-messages mb-4" style="height: 400px; overflow-y: auto;">
                        <!-- Messages will be displayed here -->
                    </div>

                    <!-- Message Input -->
                    <form id="messageForm" class="mt-3">
                        <div class="input-group">
                            <textarea id="messageInput" class="form-control" rows="2" 
                                    placeholder="اكتب سؤالك هنا..." required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>
                                إرسال
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.message {
    margin-bottom: 1rem;
    opacity: 0;
    transform: translateY(20px);
    animation: messageAppear 0.5s ease forwards;
}

@keyframes messageAppear {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-user {
    display: flex;
    justify-content: flex-end;
}

.message-scholar {
    display: flex;
    justify-content: flex-start;
}

.message-content {
    max-width: 80%;
    padding: 1rem;
    border-radius: 15px;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.message-user .message-content {
    background: var(--accent-color);
    color: white;
    border-bottom-right-radius: 5px;
}

.message-scholar .message-content {
    background: white;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.5rem;
    text-align: center;
}

.typing-indicator {
    display: flex;
    padding: 0.5rem;
    background: white;
    border-radius: 10px;
    width: fit-content;
}

.typing-dot {
    width: 8px;
    height: 8px;
    margin: 0 2px;
    background: var(--accent-color);
    border-radius: 50%;
    animation: typingAnimation 1s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0.2s; }
.typing-dot:nth-child(2) { animation-delay: 0.3s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingAnimation {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.scholar-info {
    transition: all 0.3s ease;
}

#chatHistory .list-group-item {
    border: none;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

#chatHistory .list-group-item:hover {
    background: rgba(52, 152, 219, 0.1);
}

#chatHistory .list-group-item:last-child {
    border-bottom: none;
}
</style>

<script>
const scholarInfo = {
    'abu-hanifa': {
        name: 'الإمام أبو حنيفة النعمان بن ثابت',
        info: 'إمام المذهب الحنفي ومؤسس مدرسة الرأي في الفقه الإسلامي (80-150 هـ)'
    },
    'malik': {
        name: 'الإمام مالك بن أنس بن مالك الأصبحي',
        info: 'إمام دار الهجرة وصاحب المذهب المالكي (93-179 هـ)'
    },
    'shafii': {
        name: 'الإمام محمد بن إدريس الشافعي',
        info: 'مؤسس علم أصول الفقه وصاحب المذهب الشافعي (150-204 هـ)'
    },
    'ahmad': {
        name: 'الإمام أحمد بن محمد بن حنبل الشيباني',
        info: 'إمام أهل السنة وصاحب المذهب الحنبلي (164-241 هـ)'
    },
    'bukhari': {
        name: 'الإمام محمد بن إسماعيل البخاري',
        info: 'صاحب الجامع الصحيح (صحيح البخاري) (194-256 هـ)'
    },
    'muslim': {
        name: 'الإمام مسلم بن الحجاج النيسابوري',
        info: 'صاحب المسند الصحيح (صحيح مسلم) (204-261 هـ)'
    },
    'tirmidhi': {
        name: 'الإمام محمد بن عيسى الترمذي',
        info: 'صاحب الجامع (سنن الترمذي) (209-279 هـ)'
    },
    'nasai': {
        name: 'الإمام أحمد بن شعيب النسائي',
        info: 'صاحب السنن الكبرى والصغرى (215-303 هـ)'
    },
    'ibn-majah': {
        name: 'الإمام محمد بن يزيد بن ماجه القزويني',
        info: 'صاحب السنن (سنن ابن ماجه) (209-273 هـ)'
    },
    'abu-dawood': {
        name: 'الإمام سليمان بن الأشعث السجستاني',
        info: 'صاحب السنن (سنن أبي داود) (202-275 هـ)'
    },
    'ghazali': {
        name: 'الإمام أبو حامد محمد الغزالي',
        info: 'حجة الإسلام وصاحب إحياء علوم الدين (450-505 هـ)'
    },
    'nawawi': {
        name: 'الإمام يحيى بن شرف النووي',
        info: 'صاحب رياض الصالحين والأربعين النووية (631-676 هـ)'
    },
    'ibn-taymiyyah': {
        name: 'الإمام أحمد بن عبد الحليم بن تيمية',
        info: 'شيخ الإسلام وصاحب مجموع الفتاوى (661-728 هـ)'
    },
    'ibn-kathir': {
        name: 'الإمام إسماعيل بن عمر بن كثير',
        info: 'صاحب تفسير القرآن العظيم والبداية والنهاية (700-774 هـ)'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // تحديث معلومات العالم عند تغيير الاختيار
    document.getElementById('scholarSelect').addEventListener('change', function() {
        const scholar = scholarInfo[this.value];
        document.getElementById('scholarName').textContent = scholar.name;
        document.getElementById('scholarInfo').textContent = scholar.info;
    });

    // معالجة إرسال الرسالة
    document.getElementById('messageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message) {
            addMessage(message, 'user');
            messageInput.value = '';
            showTypingIndicator();
            
            // إرسال الرسالة إلى الخادم
            const scholar = document.getElementById('scholarSelect').value;
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    scholar: scholar
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                if (data.error) {
                    showError(data.error);
                } else {
                    addMessage(data.response, 'scholar');
                    updateChatHistory(message, data.response);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                showError('حدث خطأ في الاتصال');
            });
        }
    });
});

function addMessage(text, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = text;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString();
    
    messageDiv.appendChild(content);
    messageDiv.appendChild(time);
    chatMessages.appendChild(messageDiv);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message message-scholar';
    typingDiv.id = 'typingIndicator';
    
    typingDiv.innerHTML = `
        <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
    
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.appendChild(errorDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    setTimeout(() => errorDiv.remove(), 5000);
}

function updateChatHistory(question, answer) {
    const chatHistory = document.getElementById('chatHistory');
    const historyItem = document.createElement('a');
    historyItem.className = 'list-group-item';
    historyItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-truncate">${question}</div>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
    `;
    
    historyItem.addEventListener('click', () => {
        addMessage(question, 'user');
        addMessage(answer, 'scholar');
    });
    
    chatHistory.insertBefore(historyItem, chatHistory.firstChild);
}

function clearChat() {
    if (confirm('هل أنت متأكد من رغبتك في مسح المحادثة؟')) {
        document.getElementById('chatMessages').innerHTML = '';
    }
}
</script>
{% endblock %} 