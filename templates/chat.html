{% extends "base.html" %}

{% block title %}المحادثة{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 mb-3">المحادثة مع الفقيه</h1>
        <p class="lead mb-4">تحدث مع الفقيه AI واحصل على إجابات لأسئلتك</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Chat Container -->
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        المحادثة
                    </h5>
                </div>
                <div class="card-body chat-container" id="chatContainer">
                    <!-- Messages will be added here -->
                </div>
                <div class="card-footer">
                    <form id="chatForm">
                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" rows="2"
                                    placeholder="اكتب سؤالك هنا..." required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>
                                إرسال
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Chat Info -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        معلومات المحادثة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chat-info">
                        <p><i class="fas fa-clock me-2"></i>وقت البدء: <span id="startTime"></span></p>
                        <p><i class="fas fa-comments me-2"></i>عدد الرسائل: <span id="messageCount">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-lg">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        إجراءات سريعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="clearChat()">
                            <i class="fas fa-trash me-1"></i>
                            مسح المحادثة
                        </button>
                        <button class="btn btn-outline-success" onclick="saveChat()">
                            <i class="fas fa-save me-1"></i>
                            حفظ المحادثة
                        </button>
                        <button class="btn btn-outline-info" onclick="shareChat()">
                            <i class="fas fa-share-alt me-1"></i>
                            مشاركة المحادثة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageCount = document.getElementById('messageCount');
    const startTime = document.getElementById('startTime');

    // تعيين وقت بدء المحادثة
    startTime.textContent = new Date().toLocaleTimeString('ar-EG');
    let messages = [];

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;

        // إضافة رسالة المستخدم
        addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';

        loadingOverlay.classList.remove('d-none');
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            
            if (response.ok) {
                // إضافة رد الفقيه
                addMessage('assistant', formatResponse(data.response));
                updateMessageCount();
            } else {
                showAlert('error', data.error || 'حدث خطأ في معالجة طلبك');
            }
        } catch (error) {
            showAlert('error', 'حدث خطأ في الاتصال');
        } finally {
            loadingOverlay.classList.add('d-none');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });

    // إضافة رسالة جديدة
    function addMessage(role, content) {
        const message = {
            role: role,
            content: content,
            timestamp: new Date().toLocaleTimeString('ar-EG')
        };
        messages.push(message);
        
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${role}-message`;
        messageElement.innerHTML = `
            <div class="message-content">
                ${content}
            </div>
            <div class="message-info">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>${message.timestamp}
                </small>
            </div>
        `;
        
        chatContainer.appendChild(messageElement);
        updateMessageCount();
    }

    // تنسيق الرد
    function formatResponse(response) {
        if (typeof response === 'string') {
            return response.replace(/\n/g, '<br>');
        }

        let formattedResponse = '';
        
        // تنسيق الأقسام
        if (Array.isArray(response)) {
            response.forEach(section => {
                if (section.title) {
                    formattedResponse += `<div class="response-section">
                        <h5 class="section-title">${section.title}</h5>
                        <div class="section-content">${section.content}</div>
                    </div>`;
                } else {
                    formattedResponse += `<div class="response-section">
                        <div class="section-content">${section.content}</div>
                    </div>`;
                }
            });
        } else {
            formattedResponse = response;
        }

        return formattedResponse;
    }

    // تحديث عداد الرسائل
    function updateMessageCount() {
        messageCount.textContent = messages.length;
    }

    // مسح المحادثة
    window.clearChat = function() {
        if (confirm('هل أنت متأكد من مسح المحادثة؟')) {
            chatContainer.innerHTML = '';
            messages = [];
            updateMessageCount();
        }
    }

    // حفظ المحادثة
    window.saveChat = function() {
        const chatText = messages.map(msg => 
            `[${msg.timestamp}] ${msg.role === 'user' ? 'أنت' : 'الفقيه'}:\n${msg.content}`
        ).join('\n\n');
        
        const blob = new Blob([chatText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_${new Date().toLocaleDateString('ar-EG')}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    // مشاركة المحادثة
    window.shareChat = function() {
        const chatText = messages.map(msg => 
            `[${msg.timestamp}] ${msg.role === 'user' ? 'أنت' : 'الفقيه'}:\n${msg.content}`
        ).join('\n\n');
        
        if (navigator.share) {
            navigator.share({
                title: 'محادثتي مع الفقيه AI',
                text: chatText
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(chatText).then(() => {
                showAlert('success', 'تم نسخ المحادثة إلى الحافظة');
            });
        }
    }

    // عرض التنبيهات
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        chatForm.insertAdjacentElement('beforebegin', alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // تعديل ارتفاع textarea تلقائياً
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});
</script>

<style>
.chat-container {
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
}

.chat-message {
    margin-bottom: 1rem;
    max-width: 80%;
    clear: both;
}

.user-message {
    float: right;
}

.assistant-message {
    float: left;
}

.message-content {
    padding: 1rem;
    border-radius: 15px;
    position: relative;
}

.user-message .message-content {
    background-color: #e3f2fd;
    border-bottom-right-radius: 5px;
}

.assistant-message .message-content {
    background-color: #f8f9fa;
    border-bottom-left-radius: 5px;
}

.message-info {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    text-align: right;
}

.user-message .message-info {
    text-align: left;
}

.response-section {
    margin-bottom: 1rem;
}

.section-title {
    color: var(--bs-primary);
    margin-bottom: 0.5rem;
}

.section-content {
    line-height: 1.6;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.chat-info p {
    margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
    .chat-message {
        max-width: 90%;
    }
    
    .col-lg-4 {
        margin-top: 2rem;
    }
}
</style>
{% endblock %}